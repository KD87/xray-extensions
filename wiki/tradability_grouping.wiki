#summary Управление торгуемостью, группированием и раскраски предметов в окнах обыска ящиков/трупов и торговли
#labels SHOC,gameplay

= Введение =

*[ТЧ]* Добавлено управление торгуемостью, группированием и раскраски предметов в окнах обыска ящиков/трупов и торговли. Фикс работоспособен только в связке со скриптовой частью. Управление торгуемостью, группировкой и раскраской осуществляется флажками в объекте класса CInventoryItem, которые устанавливаются через существующие функции бинарного хака. Изменить флажки надо перед тем, как будет открыто окно торговли или обыска. Изменение флажков при открытом окне не подействует вплоть до его обновления. Каждый из указанных механизмов по отдельности можно блокировать. Данный фикс также включает функционал ранее добавленного фикса от SkyLoader по раскраске слотовых предметов, в связи с чем тот фикс был удалён.

= Детали =

В классе *CInventoryItem* имеется двухбайтовое поле флагов по смещению 132. В этом поле хранятся такие флаги, как квестовость, общая торгуемость предмета, размещение и пр. Последние четыре бита там не используются. Кроме того, следующие два байта, получившиеся из-за выравнивания, тоже не используются. Эти четыре бита задействованы так:
{{{
always_tradable     = 0x1000
always_untradable   = 0x2000
ungroupable         = 0x4000
manual_highlighting = 0x8000
}}}
*always_tradable* - предмет будет продаваться вне зависимости от его движкового статуса. В целом, этот флажок пока не удалось толком использовать. Лучше оставить его в покое.

*always_untradable* - предмет не будет продаваться вне зависимости от его движкового статуса (но будет виден при продаже). Данный флажок проверяется в движковой функции, которая оценивает пригодность предмета для продажи текущему собеседнику. В чистом движке там проверяется, что предмет прописан в файле конфигурации торговли. Установка этого флажка заставит движок думать, что предмет прописан там как неторгуемый. Это в свою очередь приведёт к тому, что он, кроме того что будет заблокирован, будет также закрашен красным в окне торговли (точнее цветом с индексом 0).
При этом он будет раскрашен цветом по умолчанию для неторгуемых предметов (красным или каким задашь, это цвет с индексом 0. см. далее об этом)

*ungroupable* - предмет никогда не будет сгруппирован с ему подобными.

*manual_highlighting* - предмет будет раскрашен цветом, индекс которого задан в 4-х младших битах следующего поля (которое по смещению 134).
Цвета в палитре задаются глобальной функцией
{{{
set_highlight_color(<индекс 0-63>, GetARGB(a, r, g, b)
}}}
Цвет с индексом 0 используется для дефолтовой раскраски и по умолчанию уже установлен в красный.

Флажки и индекс цвета меняются/получаются с помощью методов класса *game_object*
{{{
item:set_inventory_item_int16(<offset>, <flags>)
flags = item:get_inventory_item_int16(nil, <offset>)
-- offset = 132/134 (флаги/индекс)
}}}

Механизмы группировки, блокировки торговли и подсветки по отдельности включаются/выключаются функциями:
{{{
set_trade_filtration_on()/set_trade_filtration_off()
set_manual_grouping_on()/set_manual_grouping_off()
set_manual_highlight_on()/set_manual_highlight_off()
}}}

Примечения:
  * Вся система работает так, что если предмет непродаваемый (по движковому условию или по флажку *always_untradable*, не имеет значения), то он будет подсвечен дефолтовым цветом подсветки вне зависимости от установленного пользовательского. Иными словами, движковая подсветка непродаваемости более приоритетна чем пользовательская. Цвет закраски непродаваемости - это цвет с индексом 0. Он по умолчанию уже выставлен в привычный красный цвет, так что его можно не трогать.
  * Флажки надо выставлять согласовано. Т.е. если предмет делается неторгуемым или подсвеченным, то надо его и разгруппировывать, иначе при манипуляциях в инвентаре будут косяки с чехардой цветов и торгуемости в стопках предметов.
  * Для использования всего этого вешаем обработчики на события старта разговора, открытия ящика/трупа, передачу предметов на пояс/слот/рюкзак. В этих обработчиках включаем/выключаем соответствующие механизмы и расставляем флажки.
  * В неиспользуемых движком флагах/полях исходно мусор. Поэтому, если механизмы включены, то надо и флажки явно расставлять *все*, которые используются включёнными механизмами. В частности, надо явно выключать флажок безусловной торгуемости.